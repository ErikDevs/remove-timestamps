<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/x-icon"
      href="images/check-badge-svgrepo-com.svg"
    />
    <title>Text Cleaner</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: auto;
        display: flex;
        width: 100vw;
        justify-content: center;
        padding: 0;
        gap: 2px;
      }

      .pasting-area {
        display: flex;
        height: 90vh;
        flex-direction: column;
        margin-top: 20px;
        padding: 10px;
        font-size: 14px;
        width: 48vw;
      }

      .cleaned-text {
        height: 95vh;
        display: flex;
        width: 48vw;
        flex-direction: column;
        padding: 10px;
        margin-left: 3px;
        font-size: 14px;
        overflow-y: auto; /* Allow scrolling if text overflows */
        border: 1px solid #ddd;
      }

      textarea {
        height: 100%;
      }
      button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
      }

      .copy-btn {
        background-color: #ff8343;
        border-radius: 5px;
        border: none;
        color: #fff;
        transition: all 0.5s ease;
      }

      .copy-btn:hover {
        background-color: #f1dec6;
      }

      .clean-btn {
        background-color: #3fa2f6;
        border-radius: 5px;
        border: none;
        color: white;
        transition: all 0.5s ease;
      }

      .clean-btn:hover {
        background-color: #96c9f4;
      }

      .text-content {
        white-space: pre-wrap; /* Preserve whitespace and line breaks */
      }
    </style>
  </head>
  <body>
    <div class="pasting-area">
      <h2>Paste Your Text Below</h2>
      <textarea
        class=""
        id="originalText"
        placeholder="Paste your text here..."
        autofocus
      ></textarea>
      <button class="clean-btn" onclick="cleanText()">Clean Text</button>
    </div>

    <div class="cleaned-text">
      <h2>Cleaned Text</h2>
      <div id="cleanedText" class="text-content"></div>
      <button class="copy-btn" onclick="copyText()">Copy to Clipboard</button>
    </div>

    <script>
      function removeConsecutiveDuplicatesInClauses(text) {
        // Split the text into sentences using regex to match punctuation marks (., !, ?)
        let sentences = text.split(/(?<=[.!?])\s+/);
        let resultSentences = [];

        sentences.forEach((sentence) => {
          // Split the sentence into clauses based on commas or semicolons
          let clauses = sentence.split(/[,;]\s*/);
          let cleanedClauses = [];

          clauses.forEach((clause) => {
            // Split the clause into words
            let words = clause.split(/\s+/);
            let cleanedWords = [];

            // Remove consecutive duplicate words without case sensitivity
            words.forEach((word, i) => {
              if (
                i === 0 ||
                word.toLowerCase() !== words[i - 1].toLowerCase()
              ) {
                cleanedWords.push(word);
              }
            });

            // Reconstruct the clause from cleaned words
            let cleanedClause = cleanedWords.join(" ");
            cleanedClauses.push(cleanedClause);
          });

          // Reconstruct the sentence from cleaned clauses
          let cleanedSentence = cleanedClauses.join(", ");
          resultSentences.push(cleanedSentence);
        });

        // Join the cleaned sentences back into a single text string
        return resultSentences.join(" ");
      }

      function cleanText() {
        const fillerWords = [
          "\\bMm-Hmm\\b",
          "\\bum\\b",
          "\\buh\\b",
          "\\bUh\\b",
          "\\bUm\\b",
          "\\bHmm\\b",
          "\\bMm\\b",
          "\\bUh-huh\\b",
          "\\bUmm\\b",
          "\\bBasically\\b",
          "\\bI think\\b",
          "\\bSo\\b",
          "\\bactually\\b",
        ];

        let originalText = document.getElementById("originalText").value;

        // Split text by each speaker section
        let speakerSections = originalText.split(
          /(?=Speaker [0-9]+\s+\d{2}:\d{2}:\d{2})/
        );

        let cleanedSections = speakerSections.map((section) => {
          // Remove the speaker's timestamp
          let cleanedSection = section.replace(
            /Speaker [0-9]+\s+\d{2}:\d{2}:\d{2}/g,
            "\n"
          );

          // Remove filler words
          fillerWords.forEach((filler) => {
            const fillerPattern = new RegExp(filler, "gi");
            cleanedSection = cleanedSection
              .replace(fillerPattern, "")
              .replace(/\s{2,}/g, " ")
              .trim();
          });

          // Remove consecutive commas, periods, question marks, exclamation points, or a mix of these
          cleanedSection = cleanedSection.replace(/([.,!?])\1+/g, "$1");

          // Remove any instance of "<...>"
          cleanedSection = cleanedSection.replace(/<[^>]*>/g, "");

          // Remove commas before or after a period or question mark
          cleanedSection = cleanedSection.replace(/\s*,\s*([.?])/g, "$1");
          cleanedSection = cleanedSection.replace(/([.?])\s*,\s*/g, "$1");

          // Remove commas with no text before them
          cleanedSection = cleanedSection.replace(/\s*,/g, "");

          // Capitalize the first letter after a period or question mark, including if it has symbols
          cleanedSection = cleanedSection.replace(
            /([.!?])\s*(['"]?)([a-z])/g,
            (match, p1, p2, p3) => {
              return p1 + " " + p2 + p3.toUpperCase();
            }
          );

          // Ensure a space after each period or question mark and capitalize the first letter after them
          cleanedSection = cleanedSection.replace(/([.?])([a-zA-Z])/g, "$1 $2");
          cleanedSection = cleanedSection.replace(
            /(?:^|[.!?]\s+)([a-z])/g,
            (match, p1) => {
              return match.replace(p1, p1.toUpperCase());
            }
          );

          // Remove duplicate words, clauses, and sentences
          return removeConsecutiveDuplicatesInClauses(cleanedSection);
        });

        // Combine cleaned sections with a line break between them
        let finalText = cleanedSections.join("\n\n");

        // Display cleaned text in a div with proper line breaks
        document.getElementById("cleanedText").innerText = finalText.trim();
      }

      function emptyTextArea() {
        document
          .getElementById("originalText")
          .addEventListener("paste", function () {
            // Set the time interval (in milliseconds) after which the textarea will be cleared
            const timeInterval = 300000; // 5 minutes
            // Clear the textarea after the specified time interval
            setTimeout(() => {
              document.getElementById("originalText").value = "";
              document.getElementById("cleanedText").innerText = "";
            }, timeInterval);
          });
      }

      emptyTextArea();

      function copyText() {
        const cleanedTextElement = document.getElementById("cleanedText");
        const range = document.createRange();
        range.selectNode(cleanedTextElement);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand("copy");
      }
    </script>
  </body>
</html>
